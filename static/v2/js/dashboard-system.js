// ===========================
// CORTEX AI DASHBOARD - SYSTEM MANAGEMENT & INTEGRATION
// System Operations & Widget Integration
// ===========================

// ===========================
// INTEGRATION TAB
// ===========================

async function updateIntegrationSnippet() {
    const snippetElement = document.getElementById('integrationSnippet');
    if (!snippetElement) return;
    
    try {
        // Get current server URL
        const serverUrl = window.location.origin;
        
        // Load user's chatbot config to get API key
        let apiKey = null;
        let botName = 'Cortex';
        try {
            const response = await fetch('/api/user/chatbot-config');
            if (response.ok) {
                const data = await response.json();
                const config = data.config || data; // Handle both {config: {...}} and direct config
                
                apiKey = config.api_key;
                botName = config.bot_name || 'Cortex';
                
                // If no API key exists, it will be generated by the endpoint
                if (!apiKey) {
                    // Reload to get the generated key
                    const reloadResponse = await fetch('/api/user/chatbot-config');
                    if (reloadResponse.ok) {
                        const reloadData = await reloadResponse.json();
                        const reloadConfig = reloadData.config || reloadData;
                        apiKey = reloadConfig.api_key;
                    }
                }
            } else {
            }
        } catch (e) {
        }
        
        if (!apiKey) {
            snippetElement.textContent = 'Error: Could not generate API key. Please refresh the page.';
            return;
        }
        
        // Generate the embed script snippet with API key
        const snippet = `<script>
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '${serverUrl}/embed.js?api_key=${apiKey}';
        s.async = 1;
        d.getElementsByTagName('head')[0].appendChild(s);
    })();
<\/script>`;
        
        snippetElement.textContent = snippet;
    } catch (error) {
        snippetElement.textContent = 'Error: Could not generate integration code. Please refresh the page.';
    }
}

function copySnippet(elementId, buttonElement) {
    const element = document.getElementById(elementId);
    if (!element) {
        return;
    }
    
    const text = element.textContent || element.innerText;
    
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        // Try to find the button - either passed as parameter, or find it by traversing DOM
        let button = buttonElement;
        if (!button) {
            // Try to find the button near the element
            const codeBlock = element.closest('.code-block');
            if (codeBlock) {
                button = codeBlock.querySelector('button.copy-btn');
            }
            // If still not found, try finding by onclick attribute
            if (!button) {
                const buttons = document.querySelectorAll(`button[onclick*="copySnippet('${elementId}')"]`);
                if (buttons.length > 0) {
                    button = buttons[0];
                }
            }
        }
        
        if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">check</span> Copied!';
            
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 2000);
        } else {
            // Fallback: show alert if button not found
            alert('‚úÖ Code copied to clipboard!');
        }
    }).catch(err => {
        alert('Failed to copy text. Please try again.');
    });
}

function refreshPreview() {
    const iframe = document.getElementById('previewFrame');
    if (iframe) {
        iframe.src = 'about:blank';
        setTimeout(() => {
            iframe.src = '/demo';
        }, 100);
    }
}

function openPreview() {
    window.open('/demo', '_blank');
}

function copyWebsiteId() {
    navigator.clipboard.writeText(currentWebsiteId).then(() => {
        // Show temporary success message
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úÖ Copied!';
        
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        alert('Failed to copy website ID. Please try again.');
    });
}

// ===========================
// SYSTEM MANAGEMENT
// ===========================

async function resetKnowledgeBase() {
    if (!confirm("‚ö†Ô∏è This will delete ALL uploaded files and AI knowledge. Continue?")) return;
    if (!confirm("üö® FINAL WARNING: This action cannot be undone! Proceed?")) return;
    
    const confirmText = prompt("Type 'RESET ALL KNOWLEDGE' to confirm this action:");
    if (confirmText !== "RESET ALL KNOWLEDGE") {
        if (typeof showErrorNotification !== 'undefined') {
            showErrorNotification("Reset cancelled - confirmation phrase did not match.");
        } else {
            alert("Reset cancelled - confirmation phrase did not match.");
        }
        return;
    }

    const resetBtn = document.getElementById('resetKnowledgeBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (resetBtn) {
        resetBtn.innerHTML = '<span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">hourglass_empty</span> Resetting Knowledge...';
        resetBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        const response = await fetch('/api/reset-knowledge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                reset_type: 'all',
                confirm_phrase: 'RESET ALL KNOWLEDGE'
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Show success notification
            if (typeof showSuccessNotification !== 'undefined') {
                showSuccessNotification('Knowledge base reset successfully! All files and vector data have been cleared.');
            } else {
                showAlert('systemSuccess', 'Knowledge base reset successfully');
            }
            
            // Refresh stats
            if (typeof loadStats === 'function') {
                setTimeout(loadStats, 1000);
            }
        } else {
            throw new Error(result.error || 'Failed to reset knowledge base');
        }
        
    } catch (error) {
        // Show error notification
        if (typeof showErrorNotification !== 'undefined') {
            showErrorNotification('Failed to reset knowledge base: ' + error.message);
        } else {
            showAlert('systemError', 'Failed to reset knowledge base: ' + error.message);
        }
    } finally {
        if (resetBtn) {
            resetBtn.innerHTML = '<span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">delete</span> Reset Knowledge Base';
            resetBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

// Removed: clearChatHistory() - No chat logs system exists
// Removed: rebuildVectorStore() - Not needed in current implementation

async function createBackup() {
    const backupBtn = document.getElementById('backupBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (backupBtn) {
        backupBtn.innerHTML = '<span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">hourglass_empty</span> Creating Backup...';
        backupBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        const response = await fetch('/api/backup-knowledge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Show success notification
            const backupLocation = result.backup_location || 'backup created';
            if (typeof showSuccessNotification !== 'undefined') {
                showSuccessNotification(`Backup created successfully! Location: ${backupLocation}`);
            } else {
                showAlert('systemSuccess', `Backup created successfully at ${backupLocation}`);
            }
            
            // Refresh stats
            if (typeof loadStats === 'function') {
                setTimeout(loadStats, 1000);
            }
        } else {
            throw new Error(result.error || 'Failed to create backup');
        }
        
    } catch (error) {
        // Show error notification
        if (typeof showErrorNotification !== 'undefined') {
            showErrorNotification('Failed to create backup: ' + error.message);
        } else {
            showAlert('systemError', 'Failed to create backup: ' + error.message);
        }
    } finally {
        if (backupBtn) {
            backupBtn.innerHTML = '<span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">backup</span> Create Backup';
            backupBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

// Removed: refreshSession() - Flask-Login handles sessions automatically, not needed
// Removed: fullSystemReset() - Too dangerous without proper safeguards, no API endpoint exists
