// ===========================
// CORTEX AI DASHBOARD - SYSTEM MANAGEMENT & INTEGRATION
// System Operations & Widget Integration
// ===========================

// ===========================
// INTEGRATION TAB
// ===========================

async function updateIntegrationSnippet() {
    const snippetElement = document.getElementById('integrationSnippet');
    if (!snippetElement) return;
    
    try {
        // Get current server URL
        const serverUrl = window.location.origin;
        
        // Load user's chatbot config to get API key
        let apiKey = null;
        let botName = 'Cortex';
        try {
            const response = await fetch('/api/user/chatbot-config');
            if (response.ok) {
                const config = await response.json();
                apiKey = config.api_key;
                botName = config.bot_name || 'Cortex';
                
                // If no API key exists, it will be generated by the endpoint
                if (!apiKey) {
                    // Reload to get the generated key
                    const reloadResponse = await fetch('/api/user/chatbot-config');
                    if (reloadResponse.ok) {
                        const reloadConfig = await reloadResponse.json();
                        apiKey = reloadConfig.api_key;
                    }
                }
            }
        } catch (e) {
            console.error('Could not load chatbot config:', e);
        }
        
        if (!apiKey) {
            snippetElement.textContent = 'Error: Could not generate API key. Please refresh the page.';
            return;
        }
        
        // Generate the embed script snippet with API key
        const snippet = `<script>
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '${serverUrl}/embed.js?api_key=${apiKey}';
        s.async = 1;
        d.getElementsByTagName('head')[0].appendChild(s);
    })();
<\/script>`;
        
        snippetElement.textContent = snippet;
    } catch (error) {
        console.error('Error updating integration snippet:', error);
        snippetElement.textContent = 'Error: Could not generate integration code. Please refresh the page.';
    }
}

function copySnippet(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent || element.innerText;
    
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… Copied!';
        
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy text. Please try again.');
    });
}

function refreshPreview() {
    const iframe = document.getElementById('previewFrame');
    if (iframe) {
        iframe.src = 'about:blank';
        setTimeout(() => {
            iframe.src = '/demo';
        }, 100);
    }
}

function openPreview() {
    window.open('/demo', '_blank');
}

function copyWebsiteId() {
    navigator.clipboard.writeText(currentWebsiteId).then(() => {
        // Show temporary success message
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… Copied!';
        
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy website ID. Please try again.');
    });
}

// ===========================
// SYSTEM MANAGEMENT
// ===========================

async function resetKnowledgeBase() {
    if (!confirm("âš ï¸ This will delete ALL uploaded files and AI knowledge. Continue?")) return;
    if (!confirm("ðŸš¨ FINAL WARNING: This action cannot be undone! Proceed?")) return;
    
    const confirmText = prompt("Type 'RESET KNOWLEDGE' to confirm this action:");
    if (confirmText !== "RESET KNOWLEDGE") {
        alert("Reset cancelled - confirmation phrase did not match.");
        return;
    }

    const resetBtn = document.getElementById('resetKnowledgeBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (resetBtn) {
        resetBtn.innerHTML = 'â³ Resetting Knowledge...';
        resetBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        showAlert('systemSuccess', 'Knowledge base reset successfully');
        setTimeout(loadStats, 1000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to reset knowledge base: ' + error.message);
    } finally {
        if (resetBtn) {
            resetBtn.innerHTML = 'ðŸ—‘ï¸ Reset Knowledge Base';
            resetBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function clearChatHistory() {
    if (!confirm("âš ï¸ This will delete ALL chat history. Continue?")) return;
    
    const clearBtn = document.getElementById('clearChatBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (clearBtn) {
        clearBtn.innerHTML = 'â³ Clearing...';
        clearBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        showAlert('systemSuccess', 'Chat history cleared successfully');
        setTimeout(loadStats, 1000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to clear chat history: ' + error.message);
    } finally {
        if (clearBtn) {
            clearBtn.innerHTML = 'ðŸ—‘ï¸ Clear Chat History';
            clearBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function rebuildVectorStore() {
    if (!confirm("âš ï¸ This will rebuild the vector store from existing files. Continue?")) return;
    
    const rebuildBtn = document.getElementById('rebuildVectorBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (rebuildBtn) {
        rebuildBtn.innerHTML = 'â³ Rebuilding...';
        rebuildBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        showAlert('systemSuccess', 'Vector store rebuilt successfully!');
        setTimeout(loadStats, 1000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to rebuild vector store: ' + error.message);
    } finally {
        if (rebuildBtn) {
            rebuildBtn.innerHTML = 'ðŸ”„ Rebuild Vector Store';
            rebuildBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function createBackup() {
    const backupBtn = document.getElementById('backupBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (backupBtn) {
        backupBtn.innerHTML = 'â³ Creating Backup...';
        backupBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        showAlert('systemSuccess', `Backup created successfully at /backups/backup-${new Date().toISOString().slice(0, 10)}.zip`);
        
    } catch (error) {
        showAlert('systemError', 'Failed to create backup: ' + error.message);
    } finally {
        if (backupBtn) {
            backupBtn.innerHTML = 'ðŸ’¾ Create Backup';
            backupBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function refreshSession() {
    const refreshBtn = document.getElementById('refreshBtn');
    
    if (refreshBtn) {
        refreshBtn.innerHTML = 'â³ Refreshing...';
        refreshBtn.disabled = true;
    }
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        showAlert('systemSuccess', 'Session refreshed successfully');
        
    } catch (error) {
        showAlert('systemError', 'Failed to refresh session: ' + error.message);
    } finally {
        if (refreshBtn) {
            refreshBtn.innerHTML = 'ðŸ”„ Refresh Session';
            refreshBtn.disabled = false;
        }
    }
}

async function fullSystemReset() {
    if (!confirm("ðŸ’€ NUCLEAR OPTION: This will delete EVERYTHING. Continue?")) return;
    if (!confirm("ðŸš¨ ABSOLUTE FINAL WARNING: ALL DATA WILL BE LOST! Proceed?")) return;
    
    const confirmText = prompt("Type 'RESET EVERYTHING' to confirm this action:");
    if (confirmText !== "RESET EVERYTHING") {
        alert("Reset cancelled - confirmation phrase did not match.");
        return;
    }

    const resetBtn = document.getElementById('fullResetBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (resetBtn) {
        resetBtn.innerHTML = 'â³ Resetting Everything...';
        resetBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API calls - replace with actual API calls
        await new Promise(resolve => setTimeout(resolve, 4000));
        
        showAlert('systemSuccess', 'Full system reset completed successfully!');
        setTimeout(() => {
            loadStats();
            loadPrompt();
        }, 2000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to perform full reset: ' + error.message);
    } finally {
        if (resetBtn) {
            resetBtn.innerHTML = 'ðŸ’€ Full System Reset';
            resetBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}
