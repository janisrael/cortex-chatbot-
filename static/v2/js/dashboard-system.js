// ===========================
// CORTEX AI DASHBOARD - SYSTEM MANAGEMENT & INTEGRATION
// System Operations & Widget Integration
// ===========================

// ===========================
// INTEGRATION TAB
// ===========================

async function updateIntegrationSnippet() {
    const snippetElement = document.getElementById('integrationSnippet');
    if (!snippetElement) return;
    
    try {
        // Get current server URL
        const serverUrl = window.location.origin;
        
        // Load user's chatbot config to get API key
        let apiKey = null;
        let botName = 'Cortex';
        try {
            const response = await fetch('/api/user/chatbot-config');
            if (response.ok) {
                const data = await response.json();
                const config = data.config || data; // Handle both {config: {...}} and direct config
                
                apiKey = config.api_key;
                botName = config.bot_name || 'Cortex';
                
                console.log('üì• Loaded config for integration snippet:', {
                    has_api_key: !!apiKey,
                    api_key_length: apiKey ? apiKey.length : 0,
                    bot_name: botName
                });
                
                // If no API key exists, it will be generated by the endpoint
                if (!apiKey) {
                    console.log('‚ö†Ô∏è No API key found, reloading to get generated key...');
                    // Reload to get the generated key
                    const reloadResponse = await fetch('/api/user/chatbot-config');
                    if (reloadResponse.ok) {
                        const reloadData = await reloadResponse.json();
                        const reloadConfig = reloadData.config || reloadData;
                        apiKey = reloadConfig.api_key;
                        console.log('‚úÖ Reloaded config, API key:', apiKey ? 'Found' : 'Still missing');
                    }
                }
            } else {
                console.error('‚ùå Failed to load chatbot config:', response.status, response.statusText);
            }
        } catch (e) {
            console.error('‚ùå Could not load chatbot config:', e);
        }
        
        if (!apiKey) {
            snippetElement.textContent = 'Error: Could not generate API key. Please refresh the page.';
            return;
        }
        
        // Generate the embed script snippet with API key
        const snippet = `<script>
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '${serverUrl}/embed.js?api_key=${apiKey}';
        s.async = 1;
        d.getElementsByTagName('head')[0].appendChild(s);
    })();
<\/script>`;
        
        snippetElement.textContent = snippet;
    } catch (error) {
        console.error('Error updating integration snippet:', error);
        snippetElement.textContent = 'Error: Could not generate integration code. Please refresh the page.';
    }
}

function copySnippet(elementId, buttonElement) {
    const element = document.getElementById(elementId);
    if (!element) {
        console.error('Element not found:', elementId);
        return;
    }
    
    const text = element.textContent || element.innerText;
    
    navigator.clipboard.writeText(text).then(() => {
        // Show temporary success message
        // Try to find the button - either passed as parameter, or find it by traversing DOM
        let button = buttonElement;
        if (!button) {
            // Try to find the button near the element
            const codeBlock = element.closest('.code-block');
            if (codeBlock) {
                button = codeBlock.querySelector('button.copy-btn');
            }
            // If still not found, try finding by onclick attribute
            if (!button) {
                const buttons = document.querySelectorAll(`button[onclick*="copySnippet('${elementId}')"]`);
                if (buttons.length > 0) {
                    button = buttons[0];
                }
            }
        }
        
        if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="material-icons-round" style="vertical-align: middle; font-size: 18px;">check</span> Copied!';
            
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 2000);
        } else {
            // Fallback: show alert if button not found
            alert('‚úÖ Code copied to clipboard!');
        }
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy text. Please try again.');
    });
}

function refreshPreview() {
    const iframe = document.getElementById('previewFrame');
    if (iframe) {
        iframe.src = 'about:blank';
        setTimeout(() => {
            iframe.src = '/demo';
        }, 100);
    }
}

function openPreview() {
    window.open('/demo', '_blank');
}

function copyWebsiteId() {
    navigator.clipboard.writeText(currentWebsiteId).then(() => {
        // Show temporary success message
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úÖ Copied!';
        
        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy website ID. Please try again.');
    });
}

// ===========================
// SYSTEM MANAGEMENT
// ===========================

async function resetKnowledgeBase() {
    if (!confirm("‚ö†Ô∏è This will delete ALL uploaded files and AI knowledge. Continue?")) return;
    if (!confirm("üö® FINAL WARNING: This action cannot be undone! Proceed?")) return;
    
    const confirmText = prompt("Type 'RESET KNOWLEDGE' to confirm this action:");
    if (confirmText !== "RESET KNOWLEDGE") {
        alert("Reset cancelled - confirmation phrase did not match.");
        return;
    }

    const resetBtn = document.getElementById('resetKnowledgeBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (resetBtn) {
        resetBtn.innerHTML = '‚è≥ Resetting Knowledge...';
        resetBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        showAlert('systemSuccess', 'Knowledge base reset successfully');
        setTimeout(loadStats, 1000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to reset knowledge base: ' + error.message);
    } finally {
        if (resetBtn) {
            resetBtn.innerHTML = 'üóëÔ∏è Reset Knowledge Base';
            resetBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function clearChatHistory() {
    if (!confirm("‚ö†Ô∏è This will delete ALL chat history. Continue?")) return;
    
    const clearBtn = document.getElementById('clearChatBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (clearBtn) {
        clearBtn.innerHTML = '‚è≥ Clearing...';
        clearBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        showAlert('systemSuccess', 'Chat history cleared successfully');
        setTimeout(loadStats, 1000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to clear chat history: ' + error.message);
    } finally {
        if (clearBtn) {
            clearBtn.innerHTML = 'üóëÔ∏è Clear Chat History';
            clearBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function rebuildVectorStore() {
    if (!confirm("‚ö†Ô∏è This will rebuild the vector store from existing files. Continue?")) return;
    
    const rebuildBtn = document.getElementById('rebuildVectorBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (rebuildBtn) {
        rebuildBtn.innerHTML = '‚è≥ Rebuilding...';
        rebuildBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 5000));
        
        showAlert('systemSuccess', 'Vector store rebuilt successfully!');
        setTimeout(loadStats, 1000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to rebuild vector store: ' + error.message);
    } finally {
        if (rebuildBtn) {
            rebuildBtn.innerHTML = 'üîÑ Rebuild Vector Store';
            rebuildBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function createBackup() {
    const backupBtn = document.getElementById('backupBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (backupBtn) {
        backupBtn.innerHTML = '‚è≥ Creating Backup...';
        backupBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        showAlert('systemSuccess', `Backup created successfully at /backups/backup-${new Date().toISOString().slice(0, 10)}.zip`);
        
    } catch (error) {
        showAlert('systemError', 'Failed to create backup: ' + error.message);
    } finally {
        if (backupBtn) {
            backupBtn.innerHTML = 'üíæ Create Backup';
            backupBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}

async function refreshSession() {
    const refreshBtn = document.getElementById('refreshBtn');
    
    if (refreshBtn) {
        refreshBtn.innerHTML = '‚è≥ Refreshing...';
        refreshBtn.disabled = true;
    }
    
    try {
        // Simulate API call - replace with actual API call
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        showAlert('systemSuccess', 'Session refreshed successfully');
        
    } catch (error) {
        showAlert('systemError', 'Failed to refresh session: ' + error.message);
    } finally {
        if (refreshBtn) {
            refreshBtn.innerHTML = 'üîÑ Refresh Session';
            refreshBtn.disabled = false;
        }
    }
}

async function fullSystemReset() {
    if (!confirm("üíÄ NUCLEAR OPTION: This will delete EVERYTHING. Continue?")) return;
    if (!confirm("üö® ABSOLUTE FINAL WARNING: ALL DATA WILL BE LOST! Proceed?")) return;
    
    const confirmText = prompt("Type 'RESET EVERYTHING' to confirm this action:");
    if (confirmText !== "RESET EVERYTHING") {
        alert("Reset cancelled - confirmation phrase did not match.");
        return;
    }

    const resetBtn = document.getElementById('fullResetBtn');
    const systemLoading = document.getElementById('systemLoading');
    
    if (resetBtn) {
        resetBtn.innerHTML = '‚è≥ Resetting Everything...';
        resetBtn.disabled = true;
    }
    if (systemLoading) systemLoading.style.display = 'block';
    
    try {
        // Simulate API calls - replace with actual API calls
        await new Promise(resolve => setTimeout(resolve, 4000));
        
        showAlert('systemSuccess', 'Full system reset completed successfully!');
        setTimeout(() => {
            loadStats();
            loadPrompt();
        }, 2000);
        
    } catch (error) {
        showAlert('systemError', 'Failed to perform full reset: ' + error.message);
    } finally {
        if (resetBtn) {
            resetBtn.innerHTML = 'üíÄ Full System Reset';
            resetBtn.disabled = false;
        }
        if (systemLoading) systemLoading.style.display = 'none';
    }
}
