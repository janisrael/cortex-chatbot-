name: Deploy Cortex Chatbot

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass docker.io

      - name: Build Docker image
        run: |
          docker build -t cortex:latest -f Dockerfile .

      - name: Save Docker image
        run: |
          docker save cortex:latest | gzip > cortex-image.tar.gz

      - name: Deploy to Server
        env:
          SERVER_HOST: 178.156.162.135
          SERVER_USER: root
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          # Copy image to server
          sshpass -p "${SERVER_PASSWORD}" scp -o StrictHostKeyChecking=no -o IdentitiesOnly=yes cortex-image.tar.gz root@${SERVER_HOST}:/tmp/
          
          # Load image and deploy
          sshpass -p "${SERVER_PASSWORD}" ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes root@${SERVER_HOST} << 'EOF'
            echo "ðŸ“¦ Loading Docker image..."
            docker load < /tmp/cortex-image.tar.gz
            rm /tmp/cortex-image.tar.gz
            
            echo "ðŸ”„ Restarting Cortex deployment..."
            kubectl rollout restart deployment/cortex-app -n cortex
            kubectl rollout status deployment/cortex-app -n cortex --timeout=120s
            
            echo "âœ… Deployment complete!"
          EOF

      - name: Health Check
        env:
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sleep 10  # Wait for service to start
          sshpass -p "${SERVER_PASSWORD}" ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes root@178.156.162.135 << 'EOF'
            echo "ðŸ¥ Running health check..."
            kubectl get pods -n cortex -l app=cortex-app
            POD=$(kubectl get pods -n cortex -l app=cortex-app --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}')
            if [ -n "$POD" ]; then
              echo "âœ… Pod is running: $POD"
              kubectl exec -n cortex $POD -- curl -f http://localhost:6001/health || echo "âš ï¸ Health check endpoint not responding"
            else
              echo "âŒ No running pod found"
              exit 1
            fi
          EOF

      - name: Deployment Summary
        if: success()
        run: |
          echo "## ðŸš€ Cortex Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker image built" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image deployed to server" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Kubernetes deployment restarted" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Health check passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service**: https://cortex.janisrael.com" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

