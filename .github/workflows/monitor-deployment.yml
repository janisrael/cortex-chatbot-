name: Monitor Deployment Status

on:
  workflow_run:
    workflows: ["Deploy to AWS"]
    types:
      - completed
      - failure
  schedule:
    # Check every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    name: Monitor Deployment Status
    runs-on: ubuntu-latest
    
    steps:
      - name: Check deployment health
        id: health_check
        run: |
          echo "=== Checking Deployment Health ==="
          
          # Check Hetzner deployment
          HETZNER_URL="${HETZNER_APP_URL:-https://cortex.janisrael.com}"
          HETZNER_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HETZNER_URL/health" || echo "000")
          
          if [ "$HETZNER_STATUS" = "200" ]; then
            echo "âœ… Hetzner deployment is healthy"
            echo "hetzner_status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âŒ Hetzner deployment is unhealthy (HTTP $HETZNER_STATUS)"
            echo "hetzner_status=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          # Check GitHub Actions workflow status
          echo "=== Checking Recent Workflow Runs ==="
          LATEST_RUN=$(gh run list --workflow=deploy.yml --limit 1 --json conclusion,status,createdAt --jq '.[0]' || echo '{"conclusion":"unknown","status":"unknown"}')
          echo "Latest run: $LATEST_RUN"
        env:
          HETZNER_APP_URL: ${{ secrets.HETZNER_APP_URL || 'https://cortex.janisrael.com' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check workflow status
        id: workflow_check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              per_page: 1
            });
            
            if (runs.workflow_runs.length > 0) {
              const latestRun = runs.workflow_runs[0];
              const conclusion = latestRun.conclusion;
              const status = latestRun.status;
              const createdAt = new Date(latestRun.created_at);
              const now = new Date();
              const minutesAgo = Math.floor((now - createdAt) / 1000 / 60);
              
              console.log(`Latest workflow run: ${conclusion} (${status}) - ${minutesAgo} minutes ago`);
              
              if (conclusion === 'failure' && minutesAgo < 30) {
                console.log('âŒ Recent deployment failure detected');
                core.setOutput('needs_retry', 'true');
                core.setOutput('run_id', latestRun.id);
              } else if (conclusion === 'success') {
                console.log('âœ… Latest deployment was successful');
                core.setOutput('needs_retry', 'false');
              } else {
                core.setOutput('needs_retry', 'false');
              }
            }
      
      - name: Auto-retry failed deployment
        if: steps.workflow_check.outputs.needs_retry == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ðŸ”„ Auto-retrying failed deployment...');
            
            // Trigger a new workflow run
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
            
            console.log('âœ… Retry workflow triggered');
      
      - name: Notify on unhealthy deployment
        if: steps.health_check.outputs.hetzner_status == 'unhealthy'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('âš ï¸ Deployment is unhealthy - manual intervention may be required');
            // Add notification logic here (email, Slack, etc.)

