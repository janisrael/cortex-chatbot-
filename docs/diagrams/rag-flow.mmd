graph TD
    Start[User Query] --> Auth{Authenticated?}
    Auth -->|No| Login[Redirect to Login]
    Auth -->|Yes| LoadConfig[Load User Config<br/>LLM Provider, Model, Settings]
    
    LoadConfig --> GetVectorstore[Get User Vectorstore<br/>chroma_db/user_{id}]
    GetVectorstore --> Query[Query Vectorstore<br/>Search for relevant docs]
    
    Query --> Retrieve[Retrieve Top 5 Documents<br/>Priority: FAQ > Crawl > File]
    
    Retrieve --> BuildContext[Build Context String<br/>Combine document contents]
    
    BuildContext --> BuildPrompt[Build RAG Prompt<br/>System Instructions + Context + Query]
    
    BuildPrompt --> GetLLM[Get LLM Instance<br/>User's Provider/Model]
    
    GetLLM --> CallAPI[Call LLM API<br/>OpenAI/Gemini/Claude/etc]
    
    CallAPI --> Response[LLM Response]
    
    Response --> Format[Format Response<br/>Add sources, clean HTML]
    
    Format --> SaveHistory[Save to Conversation<br/>Store in database]
    
    SaveHistory --> Return[Return to User]
    
    style Start fill:#4a90e2,stroke:#2c5aa0,color:#fff
    style GetVectorstore fill:#7b68ee,stroke:#5a4fcf,color:#fff
    style Retrieve fill:#50c878,stroke:#3a9d5f,color:#fff
    style CallAPI fill:#ff6b6b,stroke:#d63031,color:#fff
    style Return fill:#4a90e2,stroke:#2c5aa0,color:#fff
