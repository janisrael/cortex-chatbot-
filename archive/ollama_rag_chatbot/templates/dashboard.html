<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI Dashboard</title>


    <style>
        .reset-option {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .reset-option h4 {
            margin-bottom: 8px;
            color: #495057;
        }
        
        .reset-option p {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        
        .stat-item strong {
            display: block;
            font-size: 18px;
            color: #667eea;
        }
        
        .stat-item div {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }
        
        .backup-info {
            flex: 1;
        }
        
        .backup-name {
            font-weight: 600;
            color: #495057;
        }
        
        .backup-date {
            color: #6c757d;
            font-size: 11px;
        }
        
        .backup-actions {
            display: flex;
            gap: 5px;
        }
        
        .backup-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        
        .restore-btn {
            background: #28a745;
            color: white;
        }
        
        .delete-backup-btn {
            background: #dc3545;
            color: white;
        }
        </style>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
    
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: #f5f7fa;
                color: #333;
            }
    
            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 0;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
    
            .header-content {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
    
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 30px 20px;
            }
    
            .dashboard-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-bottom: 30px;
            }
    
            .card {
                background: white;
                border-radius: 12px;
                padding: 25px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                border: 1px solid #e1e5e9;
            }
    
            .card h2 {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 20px;
                color: #667eea;
                display: flex;
                align-items: center;
                gap: 10px;
            }
    
            /* Category Selection Styles */
            .category-tabs {
                display: flex;
                gap: 8px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
    
            .category-tab {
                background: #f8f9fa;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 8px 16px;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 12px;
                text-align: center;
                min-width: 120px;
            }
    
            .category-tab.active {
                background: white;
                border-color: #667eea;
                color: #667eea;
                font-weight: 600;
            }
    
            .category-tab:hover {
                border-color: #667eea;
                background: #f8f9ff;
            }
    
            .category-description {
                font-size: 11px;
                color: #666;
                margin-top: 4px;
                line-height: 1.3;
            }
    
            /* File Upload Enhanced */
            .file-upload {
                border: 2px dashed #ddd;
                border-radius: 8px;
                padding: 30px 20px;
                text-align: center;
                transition: all 0.2s;
                position: relative;
            }
    
            .file-upload.dragover {
                border-color: #667eea;
                background: #f8f9ff;
            }
    
            .selected-category-info {
                background: #f8f9ff;
                border: 1px solid #e1e8ff;
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 15px;
                font-size: 13px;
            }
    
            .selected-category-name {
                font-weight: 600;
                color: #667eea;
                margin-bottom: 4px;
            }
    
            /* File List by Categories */
            .files-by-category {
                max-height: 300px;
                overflow-y: auto;
            }
    
            .category-section {
                margin-bottom: 20px;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                overflow: hidden;
            }
    
            .category-header {
                background: #f8f9fa;
                padding: 12px 16px;
                border-bottom: 1px solid #e9ecef;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
            }
    
            .category-name {
                font-weight: 600;
                color: #495057;
            }
    
            .file-count-badge {
                background: #667eea;
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
            }
    
            .category-files {
                padding: 8px;
                background: white;
            }
    
            .category-files.collapsed {
                display: none;
            }
    
            .file-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 12px;
                border-radius: 6px;
                margin-bottom: 4px;
                background: #f8f9fa;
                font-size: 12px;
            }
    
            .form-group {
                margin-bottom: 20px;
            }
    
            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: #555;
            }
    
            .form-control {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.2s;
            }
    
            .form-control:focus {
                outline: none;
                border-color: #667eea;
            }
    
            textarea.form-control {
                height: 120px;
                resize: vertical;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            }
    
            .btn {
                background: #667eea;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
    
            .btn:hover {
                background: #5a6fd8;
                transform: translateY(-1px);
            }
    
            .btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }
    
            .alert {
                padding: 12px 16px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: none;
            }
    
            .alert-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
    
            .alert-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
    
            .loading {
                display: none;
                text-align: center;
                padding: 20px;
            }
    
            .spinner {
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                display: inline-block;
                margin-right: 10px;
            }
    
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
    
            .full-width {
                grid-column: 1 / -1;
            }
    
            .prompt-editor {
                height: 200px;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                font-size: 13px;
                line-height: 1.5;
            }
        </style>
    
    
    <style>
        .website-stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .website-stat-card.active {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        
        .website-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .website-stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .website-stat-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .website-stat-bot {
            font-size: 12px;
            color: #888;
        }
        
        .website-selector-option {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .website-selector-option:hover {
            background: #f8f9fa;
        }
        
        .website-selector-option.active {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ü§ñ Enhanced AI Dashboard</h1>
            <div class="nav-links">
                <a href="/" style="color: white; text-decoration: none; margin-right: 20px;">Chat Interface</a>
                <a href="/widget" style="color: white; text-decoration: none; margin-right: 20px;">Widget Preview</a>
                <a href="/health" style="color: white; text-decoration: none;">System Health</a>
            </div>
        </div>
    </div>
<!-- Website Selector and Multi-Website Management -->
<div class="container">
    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="color: white; margin-bottom: 5px;">üåê Multi-Website Management</h2>
                <p style="margin: 0; opacity: 0.9;">Manage chatbots across multiple websites</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; opacity: 0.8;">Active Website:</label>
                    <select id="websiteSelector" style="padding: 8px 12px; border-radius: 6px; border: none; font-weight: 600; min-width: 200px;">
                        <option value="default">Loading websites...</option>
                    </select>
                </div>
                <button id="addWebsiteBtn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                    ‚ûï Add Website
                </button>
            </div>
        </div>
    </div>

    <!-- Website Stats Overview -->
    <div class="stats-grid" id="websiteStats" style="margin-bottom: 30px;">
        <!-- Stats will be loaded dynamically -->
    </div>
</div>

<!-- Add Website Modal -->
<div id="addWebsiteModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 20px; color: #333;">üåê Add New Website</h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Website ID:</label>
            <input type="text" id="newWebsiteId" placeholder="example-business-com" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Use lowercase, replace dots with dashes (e.g., example-business-com)</small>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Website Name:</label>
            <input type="text" id="newWebsiteName" placeholder="Example Business" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Bot Name:</label>
            <input type="text" id="newBotName" placeholder="Alex" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Primary Color:</label>
            <input type="color" id="newPrimaryColor" value="#28a745" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; height: 40px;">
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Allowed Origins (one per line):</label>
            <textarea id="newAllowedOrigins" placeholder="https://example-business.com&#10;https://www.example-business.com" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; height: 80px; resize: vertical;"></textarea>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeAddWebsiteModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="addNewWebsite()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Add Website</button>
        </div>
    </div>
</div>
    <div class="container">
        <!-- Main Dashboard Grid -->

        <div class="card full-width" style="border: 2px solid #dc3545;">
            <h2 style="color: #dc3545;">üóëÔ∏è Reset Knowledge Base</h2>
            
            <div class="alert alert-success" id="resetSuccess"></div>
            <div class="alert alert-error" id="resetError"></div>
            
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <strong>‚ö†Ô∏è Warning:</strong> These actions permanently delete data. Always create a backup first!
            </div>
            
            <!-- Backup Section -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #495057;">üì• Backup & Restore</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <button class="btn" onclick="createBackup()" id="backupBtn" style="background: #28a745;">
                        üíæ Create Backup
                    </button>
                    <button class="btn" onclick="loadBackupList()" id="listBackupsBtn" style="background: #17a2b8;">
                        üìã View Backups
                    </button>
                </div>
                
                <div class="loading" id="backupLoading">
                    <div class="spinner"></div>
                    Creating backup...
                </div>
                
                <!-- Backup List -->
                <div id="backupsList" style="display: none;">
                    <h4>Available Backups:</h4>
                    <div id="backupsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                        <!-- Backups will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Reset Options -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="reset-option">
                    <h4>üóÇÔ∏è Files Only</h4>
                    <p>Remove all uploaded files but keep vector database and logs</p>
                    <button class="btn btn-danger" onclick="showResetModal('files')">Reset Files</button>
                </div>
                
                <div class="reset-option">
                    <h4>üß† Vector Database</h4>
                    <p>Clear learned embeddings but keep uploaded files</p>
                    <button class="btn btn-danger" onclick="showResetModal('vectors')">Reset Vectors</button>
                </div>
                
                <div class="reset-option">
                    <h4>üìä Logs & Analytics</h4>
                    <p>Clear chat logs and learning data</p>
                    <button class="btn btn-danger" onclick="showResetModal('logs')">Reset Logs</button>
                </div>
                
                <div class="reset-option">
                    <h4>üíæ Database</h4>
                    <p>Clear all conversation history from database</p>
                    <button class="btn btn-danger" onclick="showResetModal('database')">Reset Database</button>
                </div>
                
                <div class="reset-option">
                    <h4>üìù Prompt</h4>
                    <p>Reset system prompt to default</p>
                    <button class="btn btn-danger" onclick="showResetModal('prompt')">Reset Prompt</button>
                </div>
                
                <div class="reset-option" style="border: 2px solid #dc3545;">
                    <h4>üí• EVERYTHING</h4>
                    <p>Complete reset - all files, vectors, logs, database, prompt</p>
                    <button class="btn btn-danger" onclick="showResetModal('all')" style="background: #dc3545;">RESET ALL</button>
                </div>
            </div>
            
            <!-- Knowledge Base Stats -->
            <div style="background: #e9ecef; border-radius: 8px; padding: 15px;">
                <h4>üìà Current Knowledge Base Stats</h4>
                <div id="knowledgeStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                    <div class="stat-item">
                        <strong id="vectorCount">-</strong>
                        <div>Vector Documents</div>
                    </div>
                    <div class="stat-item">
                        <strong id="fileCount">-</strong>
                        <div>Uploaded Files</div>
                    </div>
                    <div class="stat-item">
                        <strong id="chatLogCount">-</strong>
                        <div>Chat Logs</div>
                    </div>
                    <div class="stat-item">
                        <strong id="userCount">-</strong>
                        <div>Users</div>
                    </div>
                    <div class="stat-item">
                        <strong id="backupCount">-</strong>
                        <div>Backups</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reset Confirmation Modal -->
        <div id="resetModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
                <h3 id="modalTitle" style="color: #dc3545; margin-bottom: 15px;">Confirm Reset</h3>
                <p id="modalDescription">This action cannot be undone.</p>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0;">
                    <strong>Required:</strong> Type <code>RESET ALL KNOWLEDGE</code> to confirm:
                    <input type="text" id="confirmationInput" placeholder="Type confirmation phrase..." style="width: 100%; margin-top: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn" onclick="closeResetModal()" style="background: #6c757d;">Cancel</button>
                    <button class="btn btn-danger" onclick="executeReset()" id="confirmResetBtn" disabled>
                        üóëÔ∏è <span id="resetButtonText">Reset</span>
                    </button>
                </div>
                
                <div class="loading" id="resetLoading" style="margin-top: 15px;">
                    <div class="spinner"></div>
                    <span id="resetLoadingText">Processing reset...</span>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Enhanced File Upload Section -->
            <div class="card">
                <h2>üìÅ Upload Documents by Category</h2>
                
                <div class="alert alert-success" id="uploadSuccess"></div>
                <div class="alert alert-error" id="uploadError"></div>
                
                <!-- Category Selection -->
                <div class="category-tabs" id="categoryTabs">
                    <!-- Categories will be loaded dynamically -->
                </div>
                
                <div class="selected-category-info" id="selectedCategoryInfo">
                    <div class="selected-category-name">Company Details</div>
                    <div class="category-description">Business information, services, team details, contact info</div>
                </div>
                
                <div class="file-upload" id="fileUpload">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
                    <p><strong>Drop files here or click to browse</strong></p>
                    <p>Supported: PDF, TXT, DOC, DOCX, CSV (Max 16MB)</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.doc,.docx,.csv">
                </div>
                
                <div class="loading" id="uploadLoading">
                    <div class="spinner"></div>
                    Processing file...
                </div>
            </div>

            <!-- URL Crawling Section -->
            <div class="card">
                <h2>üåê Crawl Websites</h2>
                
                <div class="alert alert-success" id="crawlSuccess"></div>
                <div class="alert alert-error" id="crawlError"></div>
                
                <div class="form-group">
                    <label for="urlInput">Website URL</label>
                    <div style="display: flex; gap: 12px; align-items: end;">
                        <div style="flex: 1;">
                            <input type="url" id="urlInput" class="form-control" placeholder="https://example.com">
                        </div>
                        <div>
                            <input type="number" id="maxPages" class="form-control" value="10" min="1" max="50" style="width: 80px;" title="Max pages">
                        </div>
                        <button class="btn" onclick="crawlUrl()" id="crawlBtn">
                            üï∑Ô∏è Crawl
                        </button>
                    </div>
                </div>

                <div class="loading" id="crawlLoading">
                    <div class="spinner"></div>
                    Crawling website...
                </div>
            </div>
        </div>

        <!-- Files by Category Display -->
        <div class="card full-width">
            <h2>üìÇ Files by Category</h2>
            <div class="files-by-category" id="filesByCategory">
                Loading files...
            </div>
        </div>

        <!-- Prompt Editor Section -->
        <div class="card full-width">
            <h2>‚úèÔ∏è Edit System Prompt</h2>
            
            <div class="alert alert-success" id="promptSuccess"></div>
            <div class="alert alert-error" id="promptError"></div>
            
            <div class="form-group">
                <label for="promptEditor">System Prompt Template</label>
                <textarea id="promptEditor" class="form-control prompt-editor" placeholder="Loading prompt..."></textarea>
                <small style="color: #666; margin-top: 5px; display: block;">
                    Use {context} for retrieved information and {question} for user input. HTML formatting supported.
                </small>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="savePrompt()" id="savePromptBtn">
                    üíæ Save Prompt
                </button>
                <button class="btn" onclick="resetPrompt()" style="background: #6c757d;">
                    üîÑ Reset to Default
                </button>
                <button class="btn" onclick="testPrompt()" style="background: #28a745;">
                    üß™ Test Prompt
                </button>
            </div>

            <div class="loading" id="promptLoading">
                <div class="spinner"></div>
                Updating prompt...
            </div>
        </div>
    </div>
<!-- Replace all JavaScript in your dashboard.html with this single, properly ordered script -->

<script>
// ====================================
// GLOBAL VARIABLES
// ====================================
let selectedCategory = 'company_details';
let categories = {};
let currentWebsiteId = 'default';
let websites = {};
let currentResetType = '';

// ====================================
// INITIALIZATION - Single DOMContentLoaded
// ====================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard initializing...');
    
    // Initialize all components in proper order
    initializeMultiWebsite();
    initializeFileManagement();
    initializeKnowledgeManagement();
    initializeResetSystem();
    
    console.log('‚úÖ Dashboard initialized successfully');
});

// ====================================
// MULTI-WEBSITE FUNCTIONS
// ====================================
async function initializeMultiWebsite() {
    try {
        await loadWebsites();
        setupMultiWebsiteEventListeners();
    } catch (error) {
        console.error('Failed to initialize multi-website:', error);
    }
}

async function loadWebsites() {
    try {
        const response = await fetch('/api/websites');
        const data = await response.json();
        websites = data.websites || {};
        
        updateWebsiteSelector();
        updateWebsiteStatsGrid();
        
        // Set initial website
        const firstWebsite = Object.keys(websites)[0];
        if (firstWebsite) {
            selectWebsite(firstWebsite);
        }
        
    } catch (error) {
        console.error('Failed to load websites:', error);
        // Initialize with default if API fails
        websites = {};
        currentWebsiteId = 'default';
    }
}

function updateWebsiteSelector() {
    const selector = document.getElementById('websiteSelector');
    if (!selector) return;
    
    selector.innerHTML = '';
    
    if (Object.keys(websites).length === 0) {
        const option = document.createElement('option');
        option.value = 'default';
        option.textContent = 'Default Website';
        selector.appendChild(option);
        return;
    }
    
    Object.entries(websites).forEach(([websiteId, website]) => {
        const option = document.createElement('option');
        option.value = websiteId;
        option.textContent = website.name + ' (' + website.bot_name + ')';
        selector.appendChild(option);
    });
}

function updateWebsiteStatsGrid() {
    const statsGrid = document.getElementById('websiteStats');
    if (!statsGrid) return;
    
    if (Object.keys(websites).length === 0) {
        statsGrid.innerHTML = '<div class="card" style="text-align: center; padding: 40px;"><p>No websites configured yet. <a href="#" onclick="showAddWebsiteModal()">Add your first website</a></p></div>';
        return;
    }
    
    const cards = Object.entries(websites).map(([websiteId, website]) => {
        const isActive = websiteId === currentWebsiteId ? 'active' : '';
        return '<div class="website-stat-card ' + isActive + '" onclick="selectWebsite(\'' + websiteId + '\')">' +
                    '<div class="website-stat-name">' + website.name + '</div>' +
                    '<div class="website-stat-bot">Bot: ' + website.bot_name + '</div>' +
                    '<div class="website-stat-value" id="docs-' + websiteId + '">-</div>' +
                    '<div class="website-stat-label">Documents</div>' +
                    '<div style="margin-top: 8px;">' +
                        '<span class="website-stat-value" style="font-size: 16px;" id="files-' + websiteId + '">-</span>' +
                        '<div class="website-stat-label">Files</div>' +
                    '</div>' +
                '</div>';
    });
    
    statsGrid.innerHTML = cards.join('');
    
    // Load stats for all websites
    Object.keys(websites).forEach(websiteId => {
        loadWebsiteStats(websiteId);
    });
}

function selectWebsite(websiteId) {
    currentWebsiteId = websiteId;
    
    // Update selector
    const selector = document.getElementById('websiteSelector');
    if (selector) selector.value = websiteId;
    
    // Update active card
    document.querySelectorAll('.website-stat-card').forEach(card => {
        card.classList.remove('active');
    });
    const activeCard = document.querySelector('[onclick="selectWebsite(\'' + websiteId + '\')"]');
    if (activeCard) activeCard.classList.add('active');
    
    // Update page for website
    updatePageForWebsite(websiteId);
    
    // Reload data for selected website
    loadWebsiteSpecificData(websiteId);
}

async function loadWebsiteStats(websiteId) {
    try {
        const response = await fetch('/api/website/' + websiteId + '/stats');
        const stats = await response.json();
        
        const docsElement = document.getElementById('docs-' + websiteId);
        const filesElement = document.getElementById('files-' + websiteId);
        
        if (docsElement) docsElement.textContent = stats.documents || 0;
        if (filesElement) filesElement.textContent = stats.files || 0;
        
    } catch (error) {
        console.error('Failed to load stats for ' + websiteId + ':', error);
    }
}

function updatePageForWebsite(websiteId) {
    const website = websites[websiteId];
    if (!website) return;
    
    // Update page title
    document.title = website.name + ' - AI Dashboard';
    
    // Update any website-specific UI elements
    const websiteNameElements = document.querySelectorAll('.website-name');
    websiteNameElements.forEach(element => {
        element.textContent = website.name;
    });
}

function loadWebsiteSpecificData(websiteId) {
    // Reload files by category for this website
    loadFilesByCategory();
    
    // Reload other website-specific data
    loadKnowledgeStats();
}

function setupMultiWebsiteEventListeners() {
    // Website selector change
    const selector = document.getElementById('websiteSelector');
    if (selector) {
        selector.addEventListener('change', function() {
            selectWebsite(this.value);
        });
    }
    
    // Add website button
    const addBtn = document.getElementById('addWebsiteBtn');
    if (addBtn) {
        addBtn.addEventListener('click', showAddWebsiteModal);
    }
    
    // Add website modal events
    const modal = document.getElementById('addWebsiteModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddWebsiteModal();
            }
        });
    }
    
    // Add embed code button after delay
    setTimeout(addEmbedCodeButton, 1000);
}

// ====================================
// FILE MANAGEMENT FUNCTIONS
// ====================================
async function initializeFileManagement() {
    try {
        await loadCategories();
        await loadFilesByCategory();
        setupFileUpload();
    } catch (error) {
        console.error('Failed to initialize file management:', error);
    }
}

async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        const data = await response.json();
        categories = data.categories || {};
        renderCategoryTabs();
        updateSelectedCategoryInfo();
    } catch (error) {
        console.error('Failed to load categories:', error);
    }
}

function renderCategoryTabs() {
    const tabsContainer = document.getElementById('categoryTabs');
    if (!tabsContainer) return;
    
    tabsContainer.innerHTML = '';
    
    Object.entries(categories).forEach(([categoryId, categoryInfo]) => {
        const tab = document.createElement('div');
        tab.className = 'category-tab' + (categoryId === selectedCategory ? ' active' : '');
        tab.onclick = () => selectCategory(categoryId);
        
        const nameDiv = document.createElement('div');
        nameDiv.textContent = categoryInfo.name;
        
        const descDiv = document.createElement('div');
        descDiv.className = 'category-description';
        descDiv.textContent = categoryInfo.description;
        
        tab.appendChild(nameDiv);
        tab.appendChild(descDiv);
        tabsContainer.appendChild(tab);
    });
}

function selectCategory(categoryId) {
    selectedCategory = categoryId;
    renderCategoryTabs();
    updateSelectedCategoryInfo();
}

function updateSelectedCategoryInfo() {
    const info = document.getElementById('selectedCategoryInfo');
    if (!info) return;
    
    const categoryInfo = categories[selectedCategory];
    if (categoryInfo) {
        const nameDiv = document.createElement('div');
        nameDiv.className = 'selected-category-name';
        nameDiv.textContent = categoryInfo.name;
        
        const descDiv = document.createElement('div');
        descDiv.className = 'category-description';
        descDiv.textContent = categoryInfo.description;
        
        info.innerHTML = '';
        info.appendChild(nameDiv);
        info.appendChild(descDiv);
    }
}

async function loadFilesByCategory() {
    try {
        const url = '/api/files-by-category' + (currentWebsiteId !== 'default' ? '?website_id=' + currentWebsiteId : '');
        const response = await fetch(url);
        const categoriesWithFiles = await response.json();
        renderFilesByCategory(categoriesWithFiles);
    } catch (error) {
        console.error('Failed to load files by category:', error);
    }
}

function renderFilesByCategory(categoriesWithFiles) {
    const container = document.getElementById('filesByCategory');
    if (!container) return;
    
    if (Object.keys(categoriesWithFiles).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No files uploaded yet</p>';
        return;
    }
    
    container.innerHTML = '';
    
    Object.entries(categoriesWithFiles).forEach(([categoryId, categoryData]) => {
        const section = document.createElement('div');
        section.className = 'category-section';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'category-header';
        header.onclick = () => toggleCategoryFiles(categoryId);
        
        const nameDiv = document.createElement('div');
        nameDiv.className = 'category-name';
        nameDiv.textContent = categoryData.name;
        
        const countBadge = document.createElement('div');
        countBadge.className = 'file-count-badge';
        countBadge.textContent = categoryData.file_count + ' files';
        
        header.appendChild(nameDiv);
        header.appendChild(countBadge);
        
        // Create files container
        const filesDiv = document.createElement('div');
        filesDiv.className = 'category-files';
        filesDiv.id = 'files-' + categoryId;
        
        if (categoryData.files.length === 0) {
            const noFilesP = document.createElement('p');
            noFilesP.style.cssText = 'padding: 15px; text-align: center; color: #666;';
            noFilesP.textContent = 'No files in this category';
            filesDiv.appendChild(noFilesP);
        } else {
            categoryData.files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileInfo = document.createElement('div');
                
                const fileName = document.createElement('div');
                fileName.style.fontWeight = '500';
                fileName.textContent = file.name;
                
                const fileDetails = document.createElement('div');
                fileDetails.style.cssText = 'color: #666; font-size: 11px;';
                fileDetails.textContent = formatFileSize(file.size) + ' ‚Ä¢ ' + file.modified;
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileDetails);
                fileItem.appendChild(fileInfo);
                filesDiv.appendChild(fileItem);
            });
        }
        
        section.appendChild(header);
        section.appendChild(filesDiv);
        container.appendChild(section);
    });
}

function toggleCategoryFiles(categoryId) {
    const filesDiv = document.getElementById('files-' + categoryId);
    if (filesDiv) {
        filesDiv.classList.toggle('collapsed');
    }
}

function setupFileUpload() {
    const fileUpload = document.getElementById('fileUpload');
    const fileInput = document.getElementById('fileInput');
    
    if (!fileUpload || !fileInput) return;

    fileUpload.addEventListener('click', () => fileInput.click());

    fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('dragover');
    });

    fileUpload.addEventListener('dragleave', () => {
        fileUpload.classList.remove('dragover');
    });

    fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
        handleFileUpload(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFileUpload(e.target.files);
    });
}

async function handleFileUpload(files) {
    const uploadLoading = document.getElementById('uploadLoading');
    const uploadSuccess = document.getElementById('uploadSuccess');
    const uploadError = document.getElementById('uploadError');
    
    if (uploadSuccess) uploadSuccess.style.display = 'none';
    if (uploadError) uploadError.style.display = 'none';
    
    for (let file of files) {
        if (uploadLoading) uploadLoading.style.display = 'block';
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('category', selectedCategory);
        if (currentWebsiteId !== 'default') {
            formData.append('website_id', currentWebsiteId);
        }

        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                if (uploadSuccess) {
                    uploadSuccess.textContent = result.message;
                    uploadSuccess.style.display = 'block';
                }
                setTimeout(() => {
                    loadFilesByCategory();
                }, 1000);
            } else {
                throw new Error(result.error);
            }
            
        } catch (error) {
            if (uploadError) {
                uploadError.textContent = 'Failed to upload ' + file.name + ': ' + error.message;
                uploadError.style.display = 'block';
            }
        }
    }
    
    if (uploadLoading) uploadLoading.style.display = 'none';
    const fileInput = document.getElementById('fileInput');
    if (fileInput) fileInput.value = '';
}

// ====================================
// KNOWLEDGE MANAGEMENT FUNCTIONS
// ====================================
async function initializeKnowledgeManagement() {
    try {
        await loadPrompt();
        await loadKnowledgeStats();
        setupKnowledgeEventListeners();
    } catch (error) {
        console.error('Failed to initialize knowledge management:', error);
    }
}

async function loadPrompt() {
    try {
        const response = await fetch('/api/prompt');
        const result = await response.json();
        const editor = document.getElementById('promptEditor');
        if (editor) {
            editor.value = result.prompt || '';
        }
    } catch (error) {
        console.error('Failed to load prompt:', error);
    }
}

async function loadKnowledgeStats() {
    try {
        const response = await fetch('/api/knowledge-stats-detailed');
        const stats = await response.json();
        
        const vectorCount = document.getElementById('vectorCount');
        const fileCount = document.getElementById('fileCount');
        const chatLogCount = document.getElementById('chatLogCount');
        const userCount = document.getElementById('userCount');
        const backupCount = document.getElementById('backupCount');
        
        if (vectorCount) vectorCount.textContent = stats.vector_documents || 0;
        if (fileCount) fileCount.textContent = (stats.files && stats.files.total_count) ? stats.files.total_count : 0;
        if (chatLogCount) chatLogCount.textContent = (stats.database && stats.database.chat_logs) ? stats.database.chat_logs : 0;
        if (userCount) userCount.textContent = (stats.database && stats.database.users) ? stats.database.users : 0;
        if (backupCount) backupCount.textContent = stats.backups || 0;
    } catch (error) {
        console.error('Failed to load knowledge stats:', error);
    }
}

function setupKnowledgeEventListeners() {
    // URL input enter key
    const urlInput = document.getElementById('urlInput');
    if (urlInput) {
        urlInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                crawlUrl();
            }
        });
    }
}

// ====================================
// RESET SYSTEM FUNCTIONS
// ====================================
function initializeResetSystem() {
    setupResetEventListeners();
}

function setupResetEventListeners() {
    // Confirmation input
    const confirmationInput = document.getElementById('confirmationInput');
    if (confirmationInput) {
        confirmationInput.addEventListener('input', function(e) {
            const confirmBtn = document.getElementById('confirmResetBtn');
            if (confirmBtn) {
                confirmBtn.disabled = e.target.value !== 'RESET ALL KNOWLEDGE';
            }
        });
    }
    
    // Reset modal click outside
    const resetModal = document.getElementById('resetModal');
    if (resetModal) {
        resetModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeResetModal();
            }
        });
    }
}

// ====================================
// UTILITY FUNCTIONS
// ====================================
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ====================================
// API FUNCTIONS
// ====================================
async function crawlUrl() {
    const urlInput = document.getElementById('urlInput');
    const maxPages = document.getElementById('maxPages');
    const crawlBtn = document.getElementById('crawlBtn');
    const crawlLoading = document.getElementById('crawlLoading');
    const crawlSuccess = document.getElementById('crawlSuccess');
    const crawlError = document.getElementById('crawlError');
    
    if (!urlInput) return;
    
    const url = urlInput.value.trim();
    const maxPagesValue = parseInt(maxPages && maxPages.value ? maxPages.value : '10') || 10;
    
    if (!url) {
        if (crawlError) {
            crawlError.textContent = 'Please enter a valid URL';
            crawlError.style.display = 'block';
        }
        return;
    }
    
    if (crawlSuccess) crawlSuccess.style.display = 'none';
    if (crawlError) crawlError.style.display = 'none';
    
    if (crawlBtn) crawlBtn.disabled = true;
    if (crawlLoading) crawlLoading.style.display = 'block';
    
    try {
        const response = await fetch('/api/crawl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: url,
                max_pages: maxPagesValue,
                category: 'company_details',
                website_id: currentWebsiteId !== 'default' ? currentWebsiteId : undefined
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (crawlSuccess) {
                crawlSuccess.textContent = result.message;
                crawlSuccess.style.display = 'block';
            }
            urlInput.value = '';
            setTimeout(loadFilesByCategory, 1000);
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        if (crawlError) {
            crawlError.textContent = 'Failed to crawl URL: ' + error.message;
            crawlError.style.display = 'block';
        }
    }
    
    if (crawlBtn) crawlBtn.disabled = false;
    if (crawlLoading) crawlLoading.style.display = 'none';
}

async function savePrompt() {
    const promptEditor = document.getElementById('promptEditor');
    const savePromptBtn = document.getElementById('savePromptBtn');
    const promptLoading = document.getElementById('promptLoading');
    const promptSuccess = document.getElementById('promptSuccess');
    const promptError = document.getElementById('promptError');
    
    if (!promptEditor) return;
    
    const prompt = promptEditor.value.trim();
    
    if (!prompt) {
        if (promptError) {
            promptError.textContent = 'Prompt cannot be empty';
            promptError.style.display = 'block';
        }
        return;
    }
    
    if (promptSuccess) promptSuccess.style.display = 'none';
    if (promptError) promptError.style.display = 'none';
    
    if (savePromptBtn) savePromptBtn.disabled = true;
    if (promptLoading) promptLoading.style.display = 'block';
    
    try {
        const response = await fetch('/api/prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: prompt })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (promptSuccess) {
                promptSuccess.textContent = result.message;
                promptSuccess.style.display = 'block';
            }
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        if (promptError) {
            promptError.textContent = 'Failed to save prompt: ' + error.message;
            promptError.style.display = 'block';
        }
    }
    
    if (savePromptBtn) savePromptBtn.disabled = false;
    if (promptLoading) promptLoading.style.display = 'none';
}

function resetPrompt() {
    const defaultPrompt = 'You are Bob, a real human virtual assistant for SourceSelect.ca.\n\n' +
        'Your job is to help users with their questions about SourceSelect.ca and its services. Always be polite, helpful, and conversational‚Äîjust like a friendly and attentive human agent.\n\n' +
        'INSTRUCTIONS:\n' +
        '- Vary your greetings and responses to avoid sounding repetitive or robotic.\n' +
        '- Reference the user\'s specific question in your answer.\n' +
        '- Use ONLY the information provided in the "Relevant Info" section below.\n' +
        '- If you don\'t know the answer or the information isn\'t available, respond with a polite and varied fallback such as:\n' +
        '  "That\'s a great question! I don\'t have the details on that right now, but I can help connect you to the right person."\n' +
        '  or\n' +
        '  "I\'m not sure about that, but I can help you get in touch with someone who knows more!"\n' +
        '- Only ask follow-up questions if they make sense and feel natural.\n' +
        '- Respond in HTML format (use <br> for line breaks, <ul><li> for lists, <strong> for emphasis).\n' +
        '- Keep your tone friendly and concise.\n' +
        '- Always finish with a relevant, human-sounding follow-up or offer to help further.\n\n' +
        'Relevant Info:\n' +
        '{context}\n\n' +
        'User Question: {question}\n\n' +
        'Bob\'s Response:';
    
    const promptEditor = document.getElementById('promptEditor');
    if (promptEditor) {
        promptEditor.value = defaultPrompt;
    }
}

function testPrompt() {
    window.open('/', '_blank');
}

// ====================================
// RESET FUNCTIONS
// ====================================
async function createBackup() {
    const backupBtn = document.getElementById('backupBtn');
    const backupLoading = document.getElementById('backupLoading');
    const resetSuccess = document.getElementById('resetSuccess');
    const resetError = document.getElementById('resetError');
    
    if (resetSuccess) resetSuccess.style.display = 'none';
    if (resetError) resetError.style.display = 'none';
    
    if (backupBtn) backupBtn.disabled = true;
    if (backupLoading) backupLoading.style.display = 'block';
    
    try {
        const response = await fetch('/api/backup-knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (resetSuccess) {
                resetSuccess.textContent = '‚úÖ Backup created: ' + result.backup_location;
                resetSuccess.style.display = 'block';
            }
            loadKnowledgeStats(); // Refresh stats
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        if (resetError) {
            resetError.textContent = 'Failed to create backup: ' + error.message;
            resetError.style.display = 'block';
        }
    }
    
    if (backupBtn) backupBtn.disabled = false;
    if (backupLoading) backupLoading.style.display = 'none';
}

async function loadBackupList() {
    try {
        const response = await fetch('/api/list-backups');
        const result = await response.json();
        
        const backupsList = document.getElementById('backupsList');
        const backupsContainer = document.getElementById('backupsContainer');
        
        if (!backupsList || !backupsContainer) return;
        
        backupsContainer.innerHTML = '';
        
        if (result.backups && result.backups.length > 0) {
            result.backups.forEach(backup => {
                const backupItem = document.createElement('div');
                backupItem.className = 'backup-item';
                
                const backupInfo = document.createElement('div');
                backupInfo.className = 'backup-info';
                
                const backupName = document.createElement('div');
                backupName.className = 'backup-name';
                backupName.textContent = backup.name;
                
                const backupDate = document.createElement('div');
                backupDate.className = 'backup-date';
                backupDate.textContent = backup.created + ' ‚Ä¢ ' + formatFileSize(backup.size);
                
                const backupActions = document.createElement('div');
                backupActions.className = 'backup-actions';
                
                const restoreBtn = document.createElement('button');
                restoreBtn.className = 'restore-btn';
                restoreBtn.textContent = 'Restore';
                restoreBtn.onclick = () => restoreBackup(backup.path);
                
                backupInfo.appendChild(backupName);
                backupInfo.appendChild(backupDate);
                backupActions.appendChild(restoreBtn);
                backupItem.appendChild(backupInfo);
                backupItem.appendChild(backupActions);
                backupsContainer.appendChild(backupItem);
            });
        } else {
            const noBackupsP = document.createElement('p');
            noBackupsP.style.cssText = 'text-align: center; color: #666; padding: 20px;';
            noBackupsP.textContent = 'No backups found';
            backupsContainer.appendChild(noBackupsP);
        }
        
        backupsList.style.display = 'block';
        
    } catch (error) {
        console.error('Failed to load backups:', error);
    }
}

async function restoreBackup(backupPath) {
    if (!confirm('Are you sure you want to restore from this backup? This will overwrite current data.')) {
        return;
    }
    
    const resetSuccess = document.getElementById('resetSuccess');
    const resetError = document.getElementById('resetError');
    
    if (resetSuccess) resetSuccess.style.display = 'none';
    if (resetError) resetError.style.display = 'none';
    
    try {
        const response = await fetch('/api/restore-knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ backup_path: backupPath })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (resetSuccess) {
                resetSuccess.textContent = '‚úÖ Knowledge base restored successfully!';
                resetSuccess.style.display = 'block';
            }
            loadKnowledgeStats();
            loadPrompt(); // Reload prompt if it was restored
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        if (resetError) {
            resetError.textContent = 'Failed to restore backup: ' + error.message;
            resetError.style.display = 'block';
        }
    }
}

function showResetModal(resetType) {
    currentResetType = resetType;
    
    const modal = document.getElementById('resetModal');
    const title = document.getElementById('modalTitle');
    const description = document.getElementById('modalDescription');
    const buttonText = document.getElementById('resetButtonText');
    
    if (!modal) return;
    
    const resetTypes = {
        'files': {
            title: 'üóÇÔ∏è Reset Files',
            description: 'This will permanently delete all uploaded files from all categories. Vector embeddings and chat logs will remain.',
            buttonText: 'Delete Files'
        },
        'vectors': {
            title: 'üß† Reset Vector Database', 
            description: 'This will clear the bot\'s learned embeddings and knowledge. Uploaded files will remain but need to be re-processed.',
            buttonText: 'Clear Vectors'
        },
        'logs': {
            title: 'üìä Reset Logs',
            description: 'This will delete all chat logs, analytics data, and learning information.',
            buttonText: 'Clear Logs'
        },
        'database': {
            title: 'üíæ Reset Database',
            description: 'This will delete all conversation history and user data from the database.',
            buttonText: 'Clear Database'
        },
        'prompt': {
            title: 'üìù Reset Prompt',
            description: 'This will restore the system prompt to its default state.',
            buttonText: 'Reset Prompt'
        },
        'all': {
            title: 'üí• COMPLETE RESET',
            description: 'This will delete EVERYTHING: all files, vector database, logs, database records, and reset the prompt. The bot will be completely fresh.',
            buttonText: 'RESET EVERYTHING'
        }
    };
    
    const config = resetTypes[resetType];
    if (title) title.textContent = config.title;
    if (description) description.textContent = config.description;
    if (buttonText) buttonText.textContent = config.buttonText;
    
    const confirmationInput = document.getElementById('confirmationInput');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    
    if (confirmationInput) confirmationInput.value = '';
    if (confirmResetBtn) confirmResetBtn.disabled = true;
    
    modal.style.display = 'flex';
}

function closeResetModal() {
    const modal = document.getElementById('resetModal');
    if (modal) {
        modal.style.display = 'none';
    }
    currentResetType = '';
}

async function executeReset() {
    const confirmBtn = document.getElementById('confirmResetBtn');
    const resetLoading = document.getElementById('resetLoading');
    const loadingText = document.getElementById('resetLoadingText');
    
    if (confirmBtn) confirmBtn.disabled = true;
    if (resetLoading) resetLoading.style.display = 'block';
    if (loadingText) loadingText.textContent = 'Resetting ' + currentResetType + '...';
    
    try {
        const response = await fetch('/api/reset-knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                reset_type: currentResetType,
                confirm_phrase: 'RESET ALL KNOWLEDGE'
            })
        });
        
        const result = await response.json();
        
        if (resetLoading) resetLoading.style.display = 'none';
        closeResetModal();
        
        if (response.ok) {
            const resetSuccess = document.getElementById('resetSuccess');
            if (resetSuccess) {
                resetSuccess.textContent = '‚úÖ ' + result.message;
                resetSuccess.style.display = 'block';
            }
            
            // Refresh relevant data
            loadKnowledgeStats();
            if (currentResetType === 'all' || currentResetType === 'files') {
                loadFilesByCategory();
            }
            if (currentResetType === 'all' || currentResetType === 'prompt') {
                loadPrompt();
            }
        } else {
            throw new Error(result.error);
        }
        
    } catch (error) {
        if (resetLoading) resetLoading.style.display = 'none';
        closeResetModal();
        
        const resetError = document.getElementById('resetError');
        if (resetError) {
            resetError.textContent = 'Failed to reset: ' + error.message;
            resetError.style.display = 'block';
        }
    }
}

// ====================================
// MULTI-WEBSITE MODAL FUNCTIONS
// ====================================
function showAddWebsiteModal() {
    const modal = document.getElementById('addWebsiteModal');
    if (modal) {
        modal.style.display = 'flex';
    }
}

function closeAddWebsiteModal() {
    const modal = document.getElementById('addWebsiteModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Clear form
    const fields = ['newWebsiteId', 'newWebsiteName', 'newBotName', 'newAllowedOrigins'];
    fields.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    
    const colorField = document.getElementById('newPrimaryColor');
    if (colorField) colorField.value = '#28a745';
}

async function addNewWebsite() {
    const websiteId = document.getElementById('newWebsiteId');
    const websiteName = document.getElementById('newWebsiteName');
    const botName = document.getElementById('newBotName');
    const primaryColor = document.getElementById('newPrimaryColor');
    const allowedOrigins = document.getElementById('newAllowedOrigins');
    
    const websiteIdValue = websiteId ? websiteId.value.trim() : '';
    const websiteNameValue = websiteName ? websiteName.value.trim() : '';
    const botNameValue = botName ? botName.value.trim() : '';
    const primaryColorValue = primaryColor ? primaryColor.value : '#28a745';
    const allowedOriginsValue = allowedOrigins ? allowedOrigins.value.trim().split('\n').filter(o => o.trim()) : [];
    
    if (!websiteIdValue || !websiteNameValue || !botNameValue) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (websites[websiteIdValue]) {
        alert('Website ID already exists');
        return;
    }
    
    try {
        const response = await fetch('/api/websites', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                website_id: websiteIdValue,
                name: websiteNameValue,
                bot_name: botNameValue,
                primary_color: primaryColorValue,
                allowed_origins: allowedOriginsValue
            })
        });
        
        if (response.ok) {
            closeAddWebsiteModal();
            loadWebsites(); // Reload websites
            alert('Website "' + websiteNameValue + '" added successfully!');
        } else {
            const error = await response.json();
            alert('Failed to add website: ' + error.error);
        }
        
    } catch (error) {
        alert('Error adding website: ' + error.message);
    }
}

function showEmbedCode() {
    const website = websites[currentWebsiteId];
    if (!website) return;
    
    const embedCode = '<!-- Add this to ' + website.name + ' -->\n' +
                     '<scr' + 'ipt src="' + window.location.origin + '/embed.js?website_id=' + currentWebsiteId + '"></scr' + 'ipt>';
    
    alert('Embed code for ' + website.name + ':\n\n' + embedCode);
}

function addEmbedCodeButton() {
    const headerContent = document.querySelector('.header-content .nav-links');
    if (headerContent && !document.getElementById('embedCodeBtn')) {
        const embedBtn = document.createElement('a');
        embedBtn.id = 'embedCodeBtn';
        embedBtn.href = '#';
        embedBtn.textContent = 'Get Embed Code';
        embedBtn.style.color = 'white';
        embedBtn.style.textDecoration = 'none';
        embedBtn.style.marginRight = '20px';
        embedBtn.onclick = showEmbedCode;
        headerContent.appendChild(embedBtn);
    }
}

// ====================================
// AUTO-REFRESH
// ====================================
setInterval(() => {
    loadKnowledgeStats();
    loadFilesByCategory();
}, 30000); // Refresh every 30 seconds
</script>
</body>
</html>